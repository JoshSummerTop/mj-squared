// @tiptap/extension-link@3.2.0 downloaded from https://ga.jspm.io/npm:@tiptap/extension-link@3.2.0/dist/index.js

import{combineTransactionSteps as t,getChangedRanges as e,findChildrenInRange as o,getMarksBetween as n,getAttributes as s,Mark as r,markPasteRule as i,mergeAttributes as l}from"@tiptap/core";import{tokenize as a,find as u,reset as p,registerCustomProtocol as c}from"linkifyjs";import{Plugin as d,PluginKey as h}from"@tiptap/pm/state";var f="[\0-   ᠎ -\u2029 　]";var k=new RegExp(f);var m=new RegExp(`${f}$`);var g=new RegExp(f,"g");function A(t){return t.length===1?t[0].isLink:!(t.length!==3||!t[1].isLink)&&["()","[]"].includes(t[0].value+t[2].value)}function v(s){return new d({key:new h("autolink"),appendTransaction:(r,i,l)=>{const u=r.some((t=>t.docChanged))&&!i.doc.eq(l.doc);const p=r.some((t=>t.getMeta("preventAutolink")));if(!u||p)return;const{tr:c}=l;const d=t(i.doc,[...r]);const h=e(d);h.forEach((({newRange:t})=>{const e=o(l.doc,t,(t=>t.isTextblock));let r;let i;if(e.length>1){r=e[0];i=l.doc.textBetween(r.pos,r.pos+r.node.nodeSize,void 0," ")}else if(e.length){const o=l.doc.textBetween(t.from,t.to," "," ");if(!m.test(o))return;r=e[0];i=l.doc.textBetween(r.pos,t.to,void 0," ")}if(r&&i){const t=i.split(k).filter(Boolean);if(t.length<=0)return false;const e=t[t.length-1];const o=r.pos+i.lastIndexOf(e);if(!e)return false;const u=a(e).map((t=>t.toObject(s.defaultProtocol)));if(!A(u))return false;u.filter((t=>t.isLink)).map((t=>({...t,from:o+t.start+1,to:o+t.end+1}))).filter((t=>!l.schema.marks.code||!l.doc.rangeHasMark(t.from,t.to,l.schema.marks.code))).filter((t=>s.validate(t.value))).filter((t=>s.shouldAutoLink(t.value))).forEach((t=>{n(t.from,t.to,l.doc).some((t=>t.mark.type===s.type))||c.addMark(t.from,t.to,s.type.create({href:t.href}))}))}}));return c.steps.length?c:void 0}})}function w(t){return new d({key:new h("handleClickLink"),props:{handleClick:(e,o,n)=>{var r,i;if(n.button!==0)return false;if(!e.editable)return false;let l=null;if(n.target instanceof HTMLAnchorElement)l=n.target;else{let t=n.target;const e=[];while(t.nodeName!=="DIV"){e.push(t);t=t.parentNode}l=e.find((t=>t.nodeName==="A"))}if(!l)return false;const a=s(e.state,t.type.name);const u=(r=l==null?void 0:l.href)!=null?r:a.href;const p=(i=l==null?void 0:l.target)!=null?i:a.target;t.enableClickSelection&&t.editor.commands.extendMarkRange(t.type.name);if(l&&u){window.open(u,p);return true}return false}}})}function L(t){return new d({key:new h("handlePasteLink"),props:{handlePaste:(e,o,n)=>{const{state:s}=e;const{selection:r}=s;const{empty:i}=r;if(i)return false;let l="";n.content.forEach((t=>{l+=t.textContent}));const a=u(l,{defaultProtocol:t.defaultProtocol}).find((t=>t.isLink&&t.value===l));return!(!l||!a)&&t.editor.commands.setMark(t.type,{href:a.href})}}})}var P=/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z]{2,}\b(?:[-a-zA-Z0-9@:%._+~#=?!&/]*)(?:[-a-zA-Z0-9@:%._+~#=?!&/]*)/gi;function y(t,e){const o=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];e&&e.forEach((t=>{const e=typeof t==="string"?t:t.scheme;e&&o.push(e)}));return!t||t.replace(g,"").match(new RegExp(`^(?:(?:${o.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var M=r.create({name:"link",priority:1e3,keepOnSplit:false,exitable:true,onCreate(){if(this.options.validate&&!this.options.shouldAutoLink){this.options.shouldAutoLink=this.options.validate;console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")}this.options.protocols.forEach((t=>{typeof t!=="string"?c(t.scheme,t.optionalSlashes):c(t)}))},onDestroy(){p()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:true,enableClickSelection:false,linkOnPaste:true,autolink:true,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(t,e)=>!!y(t,e.protocols),validate:t=>!!t,shouldAutoLink:t=>!!t}},addAttributes(){return{href:{default:null,parseHTML(t){return t.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:t=>{const e=t.getAttribute("href");return!(!e||!this.options.isAllowedUri(e,{defaultValidate:t=>!!y(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol}))&&null}}]},renderHTML({HTMLAttributes:t}){return this.options.isAllowedUri(t.href,{defaultValidate:t=>!!y(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",l(this.options.HTMLAttributes,t),0]:["a",l(this.options.HTMLAttributes,{...t,href:""}),0]},addCommands(){return{setLink:t=>({chain:e})=>{const{href:o}=t;return!!this.options.isAllowedUri(o,{defaultValidate:t=>!!y(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})&&e().setMark(this.name,t).setMeta("preventAutolink",true).run()},toggleLink:t=>({chain:e})=>{const{href:o}=t||{};return!(o&&!this.options.isAllowedUri(o,{defaultValidate:t=>!!y(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol}))&&e().toggleMark(this.name,t,{extendEmptyMarkRange:true}).setMeta("preventAutolink",true).run()},unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:true}).setMeta("preventAutolink",true).run()}},addPasteRules(){return[i({find:t=>{const e=[];if(t){const{protocols:o,defaultProtocol:n}=this.options;const s=u(t).filter((t=>t.isLink&&this.options.isAllowedUri(t.value,{defaultValidate:t=>!!y(t,o),protocols:o,defaultProtocol:n})));s.length&&s.forEach((t=>e.push({text:t.value,data:{href:t.href},index:t.start})))}return e},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[];const{protocols:e,defaultProtocol:o}=this.options;this.options.autolink&&t.push(v({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:t=>this.options.isAllowedUri(t,{defaultValidate:t=>!!y(t,e),protocols:e,defaultProtocol:o}),shouldAutoLink:this.options.shouldAutoLink}));this.options.openOnClick===true&&t.push(w({type:this.type,editor:this.editor,enableClickSelection:this.options.enableClickSelection}));this.options.linkOnPaste&&t.push(L({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type}));return t}});var b=M;export{M as Link,b as default,y as isAllowedUri,P as pasteRegex};

